{% extends "bar_base.html" %}
{% block BarStyles %}
<link href="/assets/css/sass_out/workorders.css" type="text/css" rel="stylesheet">
{% endblock %}
{% block BarContent%}
<input type="hidden" id="active-wo" value="{{active_wo}}">
<input type="hidden" id="new-wo" value="{{new_wo}}">
<div class="bartwo">{{count}} WORK ORDERS</div>
<div class="content">
	<div class="tabbable tabs-below">
		<div class="tab-content">
			<div class="tab-pane active" id="all">
        <div class="container">
          <div class="row">
            <div class="col-sm-3 col-xs-1"></div>
            <div class="col-sm-6 col-xs-10">
              <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                {% for wo in workorders %}
                  <div class="panel panel-default">
                    <div class="panel-heading heading" role="tab" id="{{wo.0.id}}">
                      <a role="button" data-toggle="collapse" data-parent="#accordion" href="#c{{wo.0.id}}" aria-expanded="true" aria-controls="c{{wo.0.id}}">
                      <h4 class="panel-title">
                        xxxx{{ wo.0.id|stringformat:"d"|slice:"-4:" }} :: {{wo.0.curr_state_display_name}}
                      </h4>
                      </a>
                    </div>
                    <div id="c{{wo.0.id}}" class="panel-collapse collapse workorder" role="tabpanel" aria-labelledby="{{wo.0.id}}">
                      <div class="panel-body">
                        <p>ID: {{ wo.0.id }}</p>
                        <p>APPLIANCE: {{wo.0.appliance_obj.name}}</p>
                        <p>PROVIDER: {{wo.0.provider_obj.name}}</p>
                        {% if wo.1 %}
                          {% if wo.1.0.0 == 'ESTIMATE' %}
                            <form role="form" id="estimate-form">
                              <div class="form-group">
                                  <label for="estimate">PROVIDE ESTIMATE:</label>
                                  <input type="text" class="form-control" id="estimate{{wo.0.id}}" name="estimate">
                              </div>
                              <button onclick="submit_estimate({{wo.0.id}});return false;">{{wo.1.0.0}}</button>
                            </form>
                          {% else %}
                            <form role="form">
                                <div class="form-group">
                                    <label for="notes">NOTES:</label>
                                    <input type="text" class="form-control" id="notes{{wo.0.id}}" name="notes">
                                </div>
                                {% for wo_choice in wo.1 %}
                                <button onclick="submit_notes('{{wo.0.id}}', '{{wo_choice.1}}');return false;">{{wo_choice.0}}</button><br><br>
                                {% endfor %}
                            </form>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="col-sm-3 col-xs-1"></div>
          </div>
        </div>
			</div>
		</div>
		<ul class="nav nav-tabs">
			<li class="col-xs-12 active" style="background-color: #5A9DE6;"><a href="#all" data-toggle="tab">All</a></li>
		</ul>
	</div>
</div>
{% endblock %}

{% block BarScripts %}
<script>
    $(document).ready(function(){
      var active_wo = $('#active-wo').val();
      if(active_wo) {
        $('#c'+active_wo).collapse('show');
      }
      var new_wo = $('#new-wo').val();
      if(new_wo) {
        alert('Work Order Created Successfully! Work Order ID: '+new_wo);
        $('#'+new_wo).addClass('new');
        $('#c'+new_wo).collapse('show');
      }
    });
    function submit_estimate(wo_id) {
        var params="estimate:" + $('#estimate'+wo_id).val();
        $.post("/rest/work_order/update", {'params':params,'work_order':wo_id}).done(function( data ) {
            data = JSON.parse(data);
            if(data.status == 'success') {
              setTimeout(load_workorders(), 3000);
            }
        });
    }

    function submit_notes(wo_id, args) {
        var params="notes:" + $('#notes'+wo_id).val();
        if(args) {
          params = params + ';' + args;
        }
        $.post("/rest/work_order/update", {'params':params,'work_order':wo_id}).done(function( data ) {
            data = JSON.parse(data);
            if(data.status == 'success') {
              setTimeout(load_workorders(), 3000);
            }
        });
    }

    function load_workorders() {
      window.location = window.location.origin + '/work_order/list';
    }
</script>
{% endblock%}